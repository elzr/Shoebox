<!DOCTYPE html>  <html> <head>   <title>shoebox.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               shoebox.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong><em>SHOEBOX</em></strong> is a CoffeeScript photo manager with physical interactions &amp; sortings. 
It works best in Chrome, Safari, Firefox &amp; IE9.
In IE8-, interactions are clunky but sorting's pretty smooth.</p>

<p><a href="http://jashkenas.github.com/coffee-script/">CoffeeScript 1.1.2</a> is used, pretty idiomatically.
<a href="http://jquery.com/">jQuery 1.6.2</a> and <a href="http://documentcloud.github.com/underscore/">Underscore.js 1.1.7</a> are assumed.
Blessed be John Resig &amp; Jeremy Ashkenas.</p>

<p>Made for <a href="http://momentusmedia.com/">Momentus Media</a>.</p>

<p>Coded in September 2011 by <a href="http://elzr.com/">Eli Parra</a> in Mexico City.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>BOX</h3>

<p>One of the 2 global objects that run the show. This one stands for the stage and its related properties and methods, chief among which are the sortings.</p>

<p>The general structure of BOX is:</p>

<ul>
<li>a <code>#shoebox</code> global shoebox container.</li>
<li>a <code>#toolbar</code> containing the <code>#sorts</code>, the <code>.title</code> plaque and the 1000memories logo</li>
<li>a <code>.loading</code> message</li>
<li>the main <code>#canvas</code>
<ul><li>a <code>#pics</code> container with nothing but <code>.pic</code>s</li>
<li>a <code>#chart</code> (with an <code>#axis</code>), used in date &amp; popularity sorting</li>
<li>a <code>#canvas-background</code> image</li>
<li>2 button <code>.ear</code>s at each side</li>
<li>a <code>#trash</code> bar at the bottom</li></ul></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nv">BOX = BOX =</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Are you not IE or if you are, are you at least IE9+?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">goodBrowser: </span><span class="p">(</span><span class="o">not</span> <span class="nx">$</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">msie</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span> <span class="p">(</span><span class="o">not</span> <span class="nx">$</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">msie</span><span class="p">)</span> <span class="o">and</span> <span class="nx">$</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">version</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Calculate (or just retrieve) a <strong>scale</strong> appropriate to the current window dimensions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">scale: </span><span class="nf">(recalculate)-&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">saved</span><span class="o">?</span> <span class="o">or</span> <span class="nx">recalculate</span><span class="o">?</span>
      <span class="nv">BOX.scale.saved = </span><span class="nx">H</span><span class="p">.</span><span class="nx">fit</span> <span class="p">.</span><span class="mi">75</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span><span class="o">*</span><span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1.1e6</span><span class="p">,</span> <span class="mi">2</span>
    <span class="k">else</span>
      <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">saved</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Setup sort, initial &amp; automatic resizing, and autoscrolling back to 0.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setup: </span><span class="o">-&gt;</span>
    <span class="nx">@sort</span><span class="p">.</span><span class="nx">setup</span><span class="p">()</span>
    <span class="nx">BOX</span><span class="p">.</span><span class="nx">resize</span><span class="p">()</span>
    <span class="p">(</span><span class="nx">$</span> <span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">debounce</span><span class="p">(</span><span class="nx">BOX</span><span class="p">.</span><span class="nx">resize</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">(</span><span class="nx">$</span> <span class="nb">window</span><span class="p">).</span><span class="nx">scroll</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">$</span> <span class="nb">window</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">scrollLeft</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Set lots of appropriate sizings. For one reason or another, the chore falls on us.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">size: </span><span class="o">-&gt;</span>
    <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#shoebox .canvas-background&#39;</span><span class="p">).</span><span class="nx">css</span> <span class="nv">height: </span><span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span>
    <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#canvas&#39;</span> <span class="p">).</span><span class="nx">css</span> <span class="nv">height: </span><span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span> <span class="o">-</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#shoebox #toolbar&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">(),</span> <span class="nx">top</span><span class="o">:</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#shoebox #toolbar&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span>
    <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#shoebox&#39;</span><span class="p">).</span><span class="nx">css</span> <span class="s1">&#39;padding-top&#39;</span><span class="o">:</span> <span class="p">(</span><span class="nx">$</span> <span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span>
    <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#overlay&#39;</span><span class="p">).</span><span class="nx">attr</span> <span class="nx">width</span><span class="o">:</span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">(),</span> <span class="nx">height</span><span class="o">:</span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span>
    <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#pics&#39;</span><span class="p">).</span><span class="nx">css</span> <span class="nx">width</span><span class="o">:</span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">(),</span> <span class="nx">height</span><span class="o">:</span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span>
    <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#chart&#39;</span><span class="p">).</span><span class="nx">css</span>
      <span class="nv">width: </span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span><span class="o">*</span><span class="p">.</span><span class="mi">80</span>
      <span class="nv">height: </span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span><span class="o">*</span><span class="p">.</span><span class="mi">80</span>
      <span class="nv">top: </span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span><span class="o">*</span><span class="p">.</span><span class="mi">10</span>
      <span class="nv">left: </span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span><span class="o">*</span><span class="p">.</span><span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Overly smart ear sizing appropriate to window dimensions.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;.ear&#39;</span><span class="p">).</span><span class="nx">cssMultiply</span><span class="p">([</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">],</span> <span class="nx">H</span><span class="p">.</span><span class="nx">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">()</span><span class="o">*</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span> <span class="p">).</span>
        <span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">).</span><span class="nx">cssMultiply</span><span class="p">([</span><span class="s1">&#39;margin-top&#39;</span><span class="p">,</span> <span class="s1">&#39;margin-bottom&#39;</span><span class="p">],</span> <span class="nx">H</span><span class="p">.</span><span class="nx">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">()</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)).</span>
          <span class="nx">cssMultiply</span> <span class="p">[</span><span class="s1">&#39;margin-right&#39;</span><span class="p">,</span> <span class="s1">&#39;margin-left&#39;</span><span class="p">],</span> <span class="nx">H</span><span class="p">.</span><span class="nx">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">()</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Trigger size recalculations &amp; pic repositions on window resizing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resize: </span><span class="o">-&gt;</span>
    <span class="nx">BOX</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span>
    <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="s1">&#39;recalculate&#39;</span><span class="p">)</span>

    <span class="p">(</span><span class="nx">_</span> <span class="nx">$</span> <span class="s1">&#39;.pic&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(pic)-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="nx">pic</span><span class="p">).</span><span class="nx">imgAnimate</span><span class="p">(</span><span class="nx">scale</span><span class="o">:</span><span class="p">[</span><span class="nx">H</span><span class="p">.</span><span class="nx">xy</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">()</span> <span class="o">*</span> <span class="nx">$</span><span class="p">(</span><span class="nx">pic</span><span class="p">).</span><span class="nx">data</span> <span class="s1">&#39;scale&#39;</span><span class="p">],</span> <span class="mi">600</span><span class="p">)</span>
    
    <span class="nx">BOX</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">setup</span><span class="p">()</span>
    <span class="nv">sort = </span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#sorts a.selected&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">or</span> <span class="s1">&#39;reset&#39;</span>
    <span class="nx">BOX</span><span class="p">.</span><span class="nx">sort</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
    <span class="nx">BOX</span><span class="p">.</span><span class="nx">sort</span><span class="p">[</span> <span class="nx">sort</span> <span class="p">]()</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h3>DATA</h3>

<p>Interact with external data.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">data:</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><strong>Fetch</strong> the data. The one link to the external world (currently Flickr).
It gets its parameters (Flickr set id &amp; number of images to display) from the URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">fetch: </span><span class="nf">(set, size) -&gt;</span>
      <span class="nv">PIC.total = </span><span class="nx">size</span> <span class="o">||</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">total</span>
      <span class="nx">BOX</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">flickr</span><span class="p">.</span><span class="nx">fetch</span> <span class="nx">set</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Upon return of Flickr data, <strong>render</strong> it. Put the Flickr album title in the title plaque,
mix the Flickr data with the mocks and start displaying it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">render: </span><span class="nf">(flickr) -&gt;</span>
      <span class="nx">BOX</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">setup</span> <span class="nx">flickr</span>
      <span class="nv">pics = </span><span class="nx">BOX</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">mix</span> <span class="nx">flickr</span>
      <span class="nx">PIC</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">setup</span> <span class="nx">pics</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><strong>Mix</strong> the flickr <code>data</code> randomly with mocks from <code>data.js</code> (comments, locations, dates) and plain randomn data (popularity).
Start by shuffling the photos, picking only the number we're displaying.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">mix: </span><span class="nf">(data) -&gt;</span>
      <span class="nv">pics = </span><span class="nx">H</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">photoset</span><span class="p">.</span><span class="nx">photo</span> <span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">total</span><span class="p">)</span>
      <span class="nv">comments = </span><span class="nx">H</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">(</span> <span class="nx">DATA</span><span class="p">.</span><span class="nx">comments</span> <span class="p">)</span>
      <span class="nv">pics = </span><span class="nx">_</span><span class="p">(</span><span class="nx">pics</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(pic, i)-&gt;</span>
        <span class="nv">c = </span><span class="nx">H</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">pics</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">(</span><span class="nx">pic</span><span class="p">).</span><span class="nx">extend</span>
          <span class="nv">order: </span><span class="nx">i</span>
          <span class="nv">comments: </span><span class="nx">_</span><span class="p">(</span><span class="nx">comments</span><span class="p">).</span><span class="nx">first</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
          <span class="nv">date: </span><span class="nx">H</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">(</span><span class="nx">DATA</span><span class="p">.</span><span class="nx">dates</span><span class="p">.</span><span class="nx">all</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
          <span class="nv">popularity: </span><span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="nx">H</span><span class="p">.</span><span class="nx">rand</span><span class="p">())</span>
          <span class="nv">location: </span><span class="nx">H</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">(</span><span class="nx">DATA</span><span class="p">.</span><span class="nx">locations</span><span class="p">.</span><span class="nx">all</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">comments = </span><span class="nx">_</span><span class="p">(</span><span class="nx">comments</span><span class="p">).</span><span class="nx">rest</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
        <span class="nx">pics</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="nv">DATA.pics = </span><span class="nx">pics</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Fetch a given <code>set</code> from <strong>Flickr</strong>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">flickr:</span>
      <span class="nx">fetch</span><span class="o">:</span><span class="nf">(set) -&gt;</span>
        <span class="nx">set</span> <span class="o">or=</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">sets</span><span class="p">[</span><span class="s1">&#39;family&#39;</span><span class="p">]</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span>
          <span class="s2">&quot;http://api.flickr.com/services/rest/?method=flickr.photosets.getPhotos&amp;api_key=a948a36e48c16afbf95a03c85418f417&amp;photoset_id=#{set}&amp;format=json&amp;extras=url_s&amp;jsoncallback=?&quot;</span><span class="p">,</span>
          <span class="nx">BOX</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">render</span>
        <span class="p">)</span>
            </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>SORT</h3>

<p>Sort pics by either location, popularity or date. The bulk of the BOX object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sort:</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Initial click binding &amp; width setting (to prevent glitches when bolding the text).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">setup: </span><span class="o">-&gt;</span>
      <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#sorts a&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">@click</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="o">-&gt;</span> <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">css</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">width</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>On <strong>click</strong> toggle which button is selected and trigger the appropriate sorting.
Flip back already flipped pics.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">click: </span><span class="o">-&gt;</span>
      <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#sorts a&#39;</span><span class="p">).</span><span class="o">not</span><span class="p">(</span><span class="err">@</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">)</span>
      <span class="nx">BOX</span><span class="p">.</span><span class="nx">sort</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
      <span class="nv">sort = </span><span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">()</span>
      <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;.pic.flipped:visible&#39;</span><span class="p">).</span><span class="nx">dblclick</span><span class="p">()</span>
      <span class="nx">BOX</span><span class="p">.</span><span class="nx">sort</span><span class="p">[</span> <span class="k">if</span> <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">hasClass</span> <span class="s1">&#39;selected&#39;</span> <span class="k">then</span> <span class="nx">sort</span> <span class="k">else</span> <span class="s1">&#39;reset&#39;</span> <span class="p">]()</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Reset positioning to the initial one big pile.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">reset: </span><span class="o">-&gt;</span>
      <span class="nx">BOX</span><span class="p">.</span><span class="nx">sort</span><span class="p">.</span><span class="nx">reposition</span> <span class="nx">size</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">sort</span><span class="o">:</span><span class="s1">&#39;reset&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Clear location labels &amp; chart (which contains popularity &amp; date labels).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">clear: </span><span class="o">-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#canvas .location&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chart&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Sort by <strong>location</strong>. Start by grouping pics by their location.
Reposition pics in as many piles as there were diffrent locations.
A bit later (when all pics have been repositioned), place the location labels.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">location: </span><span class="o">-&gt;</span>
      <span class="nv">grouped = </span><span class="p">(</span><span class="nx">_</span> <span class="nx">DATA</span><span class="p">.</span><span class="nx">pics</span><span class="p">).</span><span class="nx">groupBy</span> <span class="nf">(pic) -&gt;</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">location</span>
      <span class="nv">DATA.locations.present = locations = </span><span class="p">(</span><span class="nx">_</span> <span class="nx">grouped</span><span class="p">).</span><span class="nx">keys</span><span class="p">()</span>
      <span class="nx">@reposition</span> <span class="nx">size</span><span class="o">:</span><span class="nx">locations</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">sort</span><span class="o">:</span><span class="s1">&#39;location&#39;</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">delay</span> <span class="p">(</span><span class="o">=&gt;</span> <span class="p">(</span><span class="nx">@label</span><span class="p">.</span><span class="nx">location</span> <span class="nx">grouped</span><span class="p">,</span> <span class="nx">locations</span><span class="p">)),</span> <span class="mi">600</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Sort by <strong>popularity</strong>. Assign to each <em>visible</em> pic a concrete position by using popularity
as the relative proportion of the chart boundaries. Then reposition the pics and place the popularity labels.
Height is slightly damped for aesthetics.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">popularity: </span><span class="o">-&gt;</span>
      <span class="nv">chart = </span><span class="nx">@get</span><span class="p">.</span><span class="nx">chart</span><span class="p">()</span>
      <span class="nv">pops = </span><span class="nx">@get</span><span class="p">.</span><span class="nx">popularity</span><span class="p">()</span>

      <span class="p">(</span><span class="nx">_</span> <span class="nx">@get</span><span class="p">.</span><span class="nx">visible</span> <span class="nx">DATA</span><span class="p">.</span><span class="nx">pics</span> <span class="p">).</span><span class="nx">map</span> <span class="nf">(pic)-&gt;</span>
        <span class="nv">pop = </span><span class="p">(</span><span class="nx">pic</span><span class="p">.</span><span class="nx">popularity</span> <span class="o">-</span> <span class="nx">pops</span><span class="p">.</span><span class="nx">min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">pops</span><span class="p">.</span><span class="nx">max</span> <span class="o">-</span> <span class="nx">pops</span><span class="p">.</span><span class="nx">min</span><span class="p">)</span>
        <span class="nv">relative = x: </span><span class="nx">pop</span><span class="p">,</span> <span class="nv">y: </span><span class="nx">pop</span>
        <span class="nv">concrete = </span><span class="nx">H</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">multiply</span> <span class="nx">chart</span><span class="p">,</span> <span class="nx">relative</span>
        <span class="nv">pic.position =</span>
          <span class="nv">left: </span><span class="nx">chart</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">H</span><span class="p">.</span><span class="nx">fit</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">concrete</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">$html</span><span class="p">.</span><span class="nx">outerWidth</span><span class="p">(),</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">x</span>
          <span class="nv">top: </span><span class="nx">chart</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="nx">H</span><span class="p">.</span><span class="nx">fit</span> <span class="mi">50</span><span class="p">,</span> <span class="nx">concrete</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">$html</span><span class="p">.</span><span class="nx">outerHeight</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">height</span><span class="o">-</span><span class="mi">50</span>

      <span class="nx">@reposition</span><span class="p">()</span>
      <span class="nx">@label</span><span class="p">.</span><span class="nx">popularity</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Sort by <strong>date</strong>. Start by grouping pics by their date. 
Place the date labels for the found dates. Assign to each <em>visible</em> pic a concrete position relative
horizontally to its date, and around the center vertically. Reposition the pics.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">date: </span><span class="o">-&gt;</span>
      <span class="nv">grouped = </span><span class="p">(</span><span class="nx">_</span> <span class="nx">DATA</span><span class="p">.</span><span class="nx">pics</span><span class="p">).</span><span class="nx">groupBy</span> <span class="nf">(pic) -&gt;</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">date</span>
      <span class="nv">DATA.dates.present = dates = </span><span class="p">(</span><span class="nx">_</span> <span class="nx">grouped</span><span class="p">).</span><span class="nx">keys</span><span class="p">().</span><span class="nx">sort</span><span class="p">()</span>
      <span class="nx">@label</span><span class="p">.</span><span class="nx">date</span> <span class="nx">dates</span>

      <span class="nv">chart = </span><span class="nx">@get</span><span class="p">.</span><span class="nx">chart</span><span class="p">()</span>
      <span class="p">(</span><span class="nx">_</span> <span class="nx">@get</span><span class="p">.</span><span class="nx">visible</span> <span class="nx">DATA</span><span class="p">.</span><span class="nx">pics</span> <span class="p">).</span><span class="nx">map</span> <span class="nf">(pic, i, list)-&gt;</span>
        <span class="nv">group = </span><span class="nx">grouped</span><span class="p">[</span><span class="nx">pic</span><span class="p">.</span><span class="nx">date</span><span class="p">]</span>
        <span class="nv">index = </span><span class="nx">dates</span><span class="o">:</span><span class="nx">_</span><span class="p">(</span><span class="nx">dates</span><span class="p">).</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">pic</span><span class="p">.</span><span class="nx">date</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nv">date: </span><span class="p">(</span> <span class="p">((</span><span class="nx">_</span> <span class="nx">group</span><span class="p">).</span><span class="nx">indexOf</span> <span class="nx">pic</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nx">group</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">offcenter = </span><span class="k">if</span> <span class="nx">index</span><span class="p">.</span><span class="nx">date</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nx">index</span><span class="p">.</span><span class="nx">date</span><span class="o">*</span><span class="p">(</span><span class="nx">chart</span><span class="p">.</span><span class="nx">height</span><span class="err">/5)*(1+(index.date%2)*-2)</span>
        <span class="nv">relative = x: </span><span class="nx">index</span><span class="p">.</span><span class="nx">dates</span><span class="err">/dates.length, y: .5</span>
        <span class="nv">concrete = </span><span class="nx">H</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">multiply</span> <span class="nx">chart</span><span class="p">,</span> <span class="nx">relative</span>
        <span class="nv">pic.position =</span>
          <span class="nv">left: </span><span class="nx">chart</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">H</span><span class="p">.</span><span class="nx">fit</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">concrete</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">x</span>
          <span class="nv">top: </span><span class="nx">chart</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="p">(</span><span class="nx">H</span><span class="p">.</span><span class="nx">fit</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">concrete</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">$html</span><span class="p">.</span><span class="nx">outerHeight</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="nx">offcenter</span><span class="p">,</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>

      <span class="nx">@reposition</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p><strong>Reposition</strong> pics into <code>options.size</code> piles. If <code>options.sort</code> is <code>location</code> or <code>reset</code> let PIC.pile calculate their position,
otherwise each pic already has its position calculated. Animate a slow moving to that position.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">reposition: </span><span class="nf">(options = {})-&gt;</span>
      <span class="nv">PIC.pile.size = </span><span class="nx">options</span><span class="p">.</span><span class="nx">size</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">size</span>
      <span class="p">(</span><span class="nx">_</span> <span class="nx">@get</span><span class="p">.</span><span class="nx">visible</span> <span class="nx">DATA</span><span class="p">.</span><span class="nx">pics</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(pic, index, pics)-&gt;</span>
        <span class="nv">position = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">sort</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;reset&#39;</span><span class="p">]</span> <span class="k">then</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">pile</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="nx">pic</span><span class="p">.</span><span class="nx">$html</span><span class="p">,</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span> <span class="k">else</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">position</span>
        <span class="nx">pic</span><span class="p">.</span><span class="nx">$html</span><span class="p">.</span><span class="nx">animate</span> <span class="nx">position</span><span class="p">,</span> <span class="mi">600</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><strong><em>Labels</em></strong></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">label:</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Find the pic in <code>group</code> with the tallest top.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">findTop: </span><span class="nf">(group)-&gt;</span>
        <span class="nx">_</span><span class="p">(</span><span class="nx">group</span><span class="p">).</span><span class="nx">chain</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nf">(pic)-&gt;</span> <span class="nx">H</span><span class="p">.</span><span class="nx">rect</span><span class="p">.</span><span class="nx">extract</span><span class="p">(</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">$html</span><span class="p">.</span><span class="nx">find</span> <span class="s1">&#39;img&#39;</span> <span class="p">).</span><span class="nx">tl</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span>
          <span class="nx">reduce</span><span class="p">(</span> <span class="p">(</span><span class="nf">(memo, top)-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">memo</span><span class="p">,</span> <span class="nx">top</span><span class="p">)).</span><span class="nx">value</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Place <strong>location</strong> labels by relying on PIC.pile and making some adjustments
to ensure labels are never hidden behind pics. Toggle labels of deleted/restored pics.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">location: </span><span class="nf">(grouped, locations)-&gt;</span>
        <span class="p">(</span><span class="nx">_</span> <span class="nx">locations</span><span class="p">).</span><span class="nx">each</span> <span class="p">(</span><span class="nx">location</span><span class="p">)</span><span class="o">=&gt;</span>
          <span class="p">[</span><span class="nx">limit</span><span class="p">,</span> <span class="nx">concrete</span><span class="p">]</span> <span class="o">=</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">pile</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">concrete</span> <span class="nx">location</span>
          <span class="nv">$label = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;location&quot;&gt;&#39;</span><span class="o">+</span><span class="nx">location</span><span class="o">+</span><span class="s1">&#39;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">appendTo</span> <span class="s1">&#39;#canvas&#39;</span>
          <span class="nv">group = </span><span class="nx">grouped</span><span class="p">[</span><span class="nx">location</span><span class="p">]</span>
          <span class="k">if</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">sort</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">visible</span><span class="p">(</span><span class="nx">group</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="nv">top = </span><span class="nx">@findTop</span> <span class="nx">group</span>
            <span class="nx">$label</span><span class="p">.</span><span class="nx">show</span><span class="p">().</span><span class="nx">css</span>
              <span class="nv">left: </span><span class="nx">H</span><span class="p">.</span><span class="nx">fit</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">concrete</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">$label</span><span class="p">.</span><span class="nx">outerWidth</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">limit</span><span class="p">.</span><span class="nx">x</span>
              <span class="nv">top: </span><span class="nx">H</span><span class="p">.</span><span class="nx">fit</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">top</span> <span class="o">-</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">()</span><span class="o">*</span><span class="mi">20</span> <span class="o">-</span> <span class="nx">$label</span><span class="p">.</span><span class="nx">outerHeight</span><span class="p">(),</span> <span class="nx">limit</span><span class="p">.</span><span class="nx">y</span>
          <span class="k">else</span>
            <span class="nx">$label</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Place <strong>date</strong> labels proportionally across the chart's horizontal axis.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">date: </span><span class="nf">(dates)-&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chart&#39;</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">)</span>
        <span class="nv">length = </span><span class="nx">H</span><span class="p">.</span><span class="nx">float</span><span class="p">((</span><span class="nx">$</span> <span class="s1">&#39;#axis&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">())</span> <span class="o">/</span> <span class="nx">H</span><span class="p">.</span><span class="nx">float</span><span class="p">(</span><span class="nx">dates</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="nv">spans = </span><span class="p">(</span><span class="nx">_</span> <span class="nx">dates</span> <span class="p">).</span><span class="nx">map</span> <span class="nf">(date, i)-&gt;</span> <span class="s2">&quot;&lt;span style=\&quot;left:#{length*(i+.3)}px\&quot;&gt;#{date}&lt;/span&gt;&quot;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#axis&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span> <span class="nx">spans</span><span class="p">...</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Place <strong>popularity labels</strong> labels at each extreme of the chart's horizontal axis.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">popularity: </span><span class="nf">()-&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chart&#39;</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">)</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#axis&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span>
          <span class="s1">&#39;&lt;span&gt;- LEAST Popular&lt;/span&gt;&#39;</span><span class="p">,</span>
          <span class="s1">&#39;&lt;span style=&quot;left:auto; right:0&quot;&gt;+ MOST Popular&lt;/span&gt;&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Convenience methods for sorting.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">get:</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Get only <strong>visible</strong> pics.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">visible: </span><span class="nf">(pics) -&gt;</span>
        <span class="nx">_</span><span class="p">(</span><span class="nx">pics</span><span class="p">).</span><span class="nx">filter</span> <span class="nf">(pic)-&gt;</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">$html</span><span class="p">.</span><span class="o">is</span><span class="p">(</span><span class="s1">&#39;:visible&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Get position and dimensions of the <strong>chart</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">chart: </span><span class="o">-&gt;</span>
        <span class="p">(</span><span class="nv">chart = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chart&#39;</span><span class="p">)).</span><span class="nx">fadeIn</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">)</span>
        <span class="nv">out = </span><span class="nx">x</span><span class="o">:</span><span class="nx">chart</span><span class="p">.</span><span class="nx">width</span><span class="p">(),</span> <span class="nx">y</span><span class="o">:</span><span class="nx">chart</span><span class="p">.</span><span class="nx">height</span><span class="p">(),</span> <span class="nx">left</span><span class="o">:</span><span class="nx">chart</span><span class="p">.</span><span class="nx">position</span><span class="p">().</span><span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="o">:</span><span class="nx">chart</span><span class="p">.</span><span class="nx">position</span><span class="p">().</span><span class="nx">top</span><span class="p">,</span> <span class="nx">height</span><span class="o">:</span><span class="nx">chart</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span><span class="o">-</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#axis&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span><span class="o">-</span><span class="mi">150</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Get max and min popularities.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">popularity: </span><span class="o">-&gt;</span>
        <span class="nv">all = </span><span class="p">(</span><span class="nx">_</span> <span class="nx">@visible</span> <span class="nx">DATA</span><span class="p">.</span><span class="nx">pics</span> <span class="p">).</span><span class="nx">chain</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span> <span class="nf">(pic)-&gt;</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">popularity</span><span class="p">)</span>
        <span class="nx">all</span><span class="o">:</span><span class="nx">all</span><span class="p">,</span> <span class="nx">max</span><span class="o">:</span><span class="nx">all</span><span class="p">.</span><span class="nx">max</span><span class="p">().</span><span class="nx">value</span><span class="p">(),</span> <span class="nx">min</span><span class="o">:</span><span class="nx">all</span><span class="p">.</span><span class="nx">min</span><span class="p">().</span><span class="nx">value</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h3>TITLE</h3>

<p>A dynamically sized title plaque.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">title:</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Load the set's title and make the plaque visible.
Bind focus, keyup, hvoer. Initialize min &amp; max height &amp; width.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">setup</span><span class="o">:</span><span class="nf">(data)-&gt;</span>
      <span class="nv">ta = </span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#toolbar textarea&#39;</span><span class="p">)</span>
      <span class="nv">title = </span><span class="k">if</span> <span class="nx">data</span> <span class="k">then</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">photoset</span><span class="p">.</span><span class="nx">ownername</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;s Shoebox&quot;</span> <span class="k">else</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
      
      <span class="nx">ta</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span> <span class="nx">title</span> <span class="p">).</span><span class="nx">focus</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">addClass</span> <span class="s1">&#39;focus&#39;</span><span class="p">).</span><span class="nx">blur</span><span class="p">(</span><span class="o">-&gt;</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s1">&#39;focus&#39;</span><span class="p">).</span>
        <span class="nx">keyup</span><span class="p">(</span><span class="nx">@change</span><span class="p">).</span><span class="nx">data</span>
          <span class="nv">width:</span>
            <span class="nv">max: </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#toolbar .container&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span> <span class="o">-</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.logo-1000&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span> <span class="o">-</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#sorts&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span> <span class="o">-</span> <span class="mi">400</span>
            <span class="nv">min: </span><span class="nx">ta</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span>
          <span class="nv">height:</span>
            <span class="nv">min: </span><span class="nx">ta</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span>
      <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#toolbar .shadow&#39;</span><span class="p">).</span><span class="nx">css</span> <span class="s1">&#39;max-width&#39;</span><span class="p">,</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">).</span><span class="nx">max</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#toolbar .title&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;visibility&#39;</span><span class="p">,</span> <span class="s1">&#39;visible&#39;</span><span class="p">).</span><span class="nx">hover</span><span class="p">(</span> <span class="p">(</span><span class="o">-&gt;</span><span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">addClass</span> <span class="s1">&#39;hover&#39;</span><span class="p">),</span> <span class="o">-&gt;</span><span class="p">((</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">removeClass</span> <span class="s1">&#39;hover&#39;</span><span class="p">))</span>
      <span class="nx">@change</span><span class="p">.</span><span class="nx">call</span> <span class="nx">ta</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>For some reason, an accurate initial height needs this double call (?)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@change</span><span class="p">.</span><span class="nx">call</span> <span class="nx">ta</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Reproduce each <strong>change</strong> in the title plaque to an invisible shadow div.
Then synchronize the title plaque's height &amp; width with the shadow div's -- within bounds.
It gets extra complicated by the need to handle padding's &amp; margin's when updating two objects, both the title plaque and its background img.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">change</span><span class="o">:</span><span class="nf">()-&gt;</span>
      <span class="nv">ta = </span><span class="nx">$</span> <span class="err">@</span>
      <span class="nv">shadow = </span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#toolbar .shadow&#39;</span><span class="p">).</span><span class="nx">text</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39; &#39;</span>
      <span class="nv">padding = </span><span class="mi">2</span><span class="o">*</span><span class="nx">H</span><span class="p">.</span><span class="nx">float</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;padding-top&#39;</span><span class="p">)</span>
      <span class="nv">margin = </span><span class="mi">2</span><span class="o">*</span><span class="nx">H</span><span class="p">.</span><span class="nx">float</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;margin-top&#39;</span><span class="p">)</span>
      <span class="nx">ta</span><span class="p">.</span><span class="nx">css</span>
        <span class="nv">width: </span><span class="nx">H</span><span class="p">.</span><span class="nx">fit</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">).</span><span class="nx">min</span><span class="p">,</span> <span class="nx">shadow</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span><span class="o">+</span><span class="mi">50</span><span class="p">,</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">).</span><span class="nx">max</span>
        <span class="nv">height: </span><span class="nx">H</span><span class="p">.</span><span class="nx">fit</span> <span class="nx">ta</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">).</span><span class="nx">min</span><span class="p">,</span> <span class="nx">shadow</span><span class="p">.</span><span class="nx">height</span><span class="p">(),</span> <span class="mi">100</span>
      <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#toolbar img.background&#39;</span><span class="p">).</span><span class="nx">css</span>
        <span class="nv">width: </span><span class="nx">ta</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span><span class="o">+</span><span class="nx">padding</span><span class="o">+</span><span class="mi">2</span>
        <span class="nv">height: </span><span class="nx">ta</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span><span class="o">+</span><span class="nx">padding</span><span class="o">+</span><span class="mi">2</span>
      <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#toolbar .title&#39;</span><span class="p">).</span><span class="nx">css</span>
        <span class="nv">width: </span><span class="nx">ta</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span><span class="o">+</span><span class="nx">padding</span><span class="o">+</span><span class="nx">margin</span><span class="o">+</span><span class="mi">2</span>
        <span class="nv">height: </span><span class="nx">ta</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span><span class="o">+</span><span class="nx">padding</span><span class="o">+</span><span class="nx">margin</span><span class="o">+</span><span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h3>PIC:</h3>

<p>One of the 2 global objects that make it all work. This one deals with, well, pics.
Pics consist of a container <code>.pic</code> div and 2 children: an <code>img</code> and a <code>.backside</code> which holds comments.
Occasionally I use a superobject derived stored at <code>DATA.pics</code> which contains further data associated with pic.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nv">PIC = PIC =</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Total number of pictures we want to display (1...30?). </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">total</span><span class="o">:</span><span class="mi">8</span>
  <span class="nv">css:</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Maximum rotation degrees allowed (positive or negative).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">rotation</span><span class="o">:</span><span class="mi">45</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Initial base scaling of all pics.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">scale</span><span class="o">:</span><span class="p">.</span><span class="mi">75</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Flickr sets (ids) to fetch photos from.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sets:</span>
    <span class="nx">family</span><span class="o">:</span><span class="s1">&#39;72157594183166324&#39;</span>

<span class="p">(</span><span class="nx">_</span> <span class="nx">PIC</span><span class="p">).</span><span class="nx">extend</span><span class="p">(</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <h3>PILE:</h3>

<p>In charge of <em>placing</em> pics into piles.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pile:</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>How many piles?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">size</span><span class="o">:</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Hard-coded relative positions for 1 to 5 piles.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">positions</span><span class="o">:</span><span class="p">[</span>
      <span class="p">[</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">5</span><span class="p">}</span> <span class="p">]</span>
      <span class="p">[</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">4</span><span class="p">}</span> <span class="p">]</span>
      <span class="p">[</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">25</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">75</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">25</span><span class="p">},</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">6</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">75</span><span class="p">}</span> <span class="p">]</span>
      <span class="p">[</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">25</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">25</span><span class="p">},</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">25</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">75</span><span class="p">},</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">75</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">25</span><span class="p">},</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">75</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">75</span><span class="p">}</span> <span class="p">]</span>
      <span class="p">[</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">75</span><span class="p">},</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">5</span><span class="p">}</span> <span class="p">,</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">75</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="p">.</span><span class="mi">75</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="p">.</span><span class="mi">75</span><span class="p">}</span> <span class="p">]</span>
    <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Get a <strong>pile</strong>'s relative or concrete position.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">position:</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Fetch a pile's <strong>relative</strong> position.
Either there's only one pile,
or the index is the pic's location,
or there are many piles (legacy case).</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">relative: </span><span class="nf">(count)-&gt;</span>
        <span class="nv">index = </span><span class="k">if</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">pile</span><span class="p">.</span><span class="nx">size</span> <span class="o">==</span> <span class="mi">1</span>
              <span class="mi">0</span>
          <span class="k">else</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">count</span><span class="p">).</span><span class="nx">isString</span><span class="p">()</span>
              <span class="p">(</span><span class="nx">_</span> <span class="nx">DATA</span><span class="p">.</span><span class="nx">locations</span><span class="p">.</span><span class="nx">present</span><span class="p">).</span><span class="nx">indexOf</span> <span class="nx">count</span>
            <span class="k">else</span>
              <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">count</span><span class="err">/PIC.total/PIC.pile.size</span>
        <span class="nx">PIC</span><span class="p">.</span><span class="nx">pile</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">pile</span><span class="p">.</span><span class="nx">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">][</span> <span class="nx">index</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Calculate a pile's <strong>concrete</strong> position
by multiplying the absolute boundaries by the relative values.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">concrete: </span><span class="nf">(count) -&gt;</span>
        <span class="nv">relative = </span><span class="nx">@relative</span> <span class="nx">count</span>
        <span class="nv">chart = </span><span class="nx">x</span><span class="o">:</span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">(),</span> <span class="nx">y</span><span class="o">:</span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span>
        <span class="nv">concrete = </span><span class="nx">H</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">multiply</span> <span class="nx">chart</span><span class="p">,</span> <span class="nx">relative</span>
        <span class="p">[</span> <span class="nx">chart</span><span class="p">,</span> <span class="nx">concrete</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Calculate a <strong>pic</strong>'s (not a pile's) position according to its count (order).
<strong>Radius</strong> is how far from a pile's position a pic can randomly get placed.
For more than one pile, y-radius is 0 for more useful location sorting.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">place: </span><span class="nf">(pic, count) -&gt;</span>
      <span class="p">[</span><span class="nx">chart</span><span class="p">,</span> <span class="nx">concrete</span><span class="p">]</span> <span class="o">=</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">pile</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">concrete</span> <span class="nx">count</span>
      <span class="nv">radius = </span><span class="k">if</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">pile</span><span class="p">.</span><span class="nx">size</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="mi">400</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="mi">400</span><span class="p">}</span>  <span class="k">else</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="mi">200</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="mi">0</span><span class="p">}</span>
      <span class="nv">offset = </span><span class="nx">H</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">multiply</span> <span class="nx">radius</span><span class="p">,</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">H</span><span class="p">.</span><span class="nx">rand</span><span class="p">(),</span> <span class="nx">y</span><span class="o">:</span><span class="nx">H</span><span class="p">.</span><span class="nx">rand</span><span class="p">()}</span>
      <span class="nv">left: </span><span class="nx">H</span><span class="p">.</span><span class="nx">fit</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">concrete</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">$</span><span class="p">(</span><span class="nx">pic</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">x</span> <span class="p">)</span>
      <span class="nv">top: </span><span class="nx">H</span><span class="p">.</span><span class="nx">fit</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">concrete</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">$</span><span class="p">(</span><span class="nx">pic</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">y</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <h3>STACK</h3>

<p>Awareness of pic stacks.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">stack:</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Get the <strong>topmost</strong> z-index of all pics, plus one.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">topmost: </span><span class="o">-&gt;</span> <span class="nx">_</span><span class="p">(</span> <span class="nx">@index</span><span class="p">(</span><span class="nx">pic</span><span class="p">)</span> <span class="k">for</span> <span class="nx">pic</span> <span class="k">in</span> <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#pics .pic&#39;</span><span class="p">)</span> <span class="p">).</span><span class="nx">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Get a pic's <strong>z-index</strong>, ensuring it is always an integer (not a string, like 'auto').</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">index: </span><span class="nf">(obj)-&gt;</span> <span class="o">~~</span><span class="nx">$</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;z-index&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Get the <code>pics</code> that are <em>stacked</em> <code>atop</code> or <code>below</code> the <code>from</code> element.
Atop-below-ness is determined with z-indexes.
Stacked-ness is determined by intersecting the rectangles of each <code>pic</code> with <code>from</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">get: </span><span class="nf">(atopBelow, from, pics)-&gt;</span>
      <span class="nv">flip = </span><span class="p">{</span><span class="nx">atop</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">below</span><span class="o">:-</span><span class="mi">1</span><span class="p">}[</span><span class="nx">atopBelow</span><span class="p">]</span>
      <span class="nx">pics</span> <span class="o">?=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#pics .pic&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;topStack&#39;</span><span class="p">)</span>
      <span class="nv">fromRect = </span><span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="nx">from</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;pic&#39;</span><span class="p">)</span> <span class="k">then</span> <span class="nx">$</span><span class="p">(</span><span class="nx">from</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nx">$</span><span class="p">(</span><span class="nx">from</span><span class="p">)</span>
      <span class="nx">pic</span> <span class="k">for</span> <span class="nx">pic</span> <span class="k">in</span> <span class="nx">pics</span> <span class="k">when</span> <span class="nx">flip</span><span class="o">*</span><span class="nx">@index</span><span class="p">(</span><span class="nx">from</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">flip</span><span class="o">*</span><span class="nx">@index</span><span class="p">(</span><span class="nx">pic</span><span class="p">)</span> <span class="o">and</span> <span class="nx">H</span><span class="p">.</span><span class="nx">rect</span><span class="p">.</span><span class="nx">intersect</span> <span class="nx">fromRect</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="nx">pic</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p><strong>Clear away</strong>, momentarily (<code>flip</code>), <code>from</code>'s <code>stack</code>, by <code>delta</code> pixels</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_clear: </span><span class="nf">(stack, from)-&gt;</span>
      <span class="p">[</span><span class="nx">flip</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span> <span class="nx">from</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;-=&#39;</span><span class="o">:</span><span class="s1">&#39;+=&#39;</span><span class="p">,</span> <span class="s1">&#39;+=&#39;</span><span class="o">:</span><span class="s1">&#39;-=&#39;</span><span class="p">},</span> <span class="s1">&#39;75px&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">$</span> <span class="nx">from</span><span class="p">)]</span>
      <span class="k">for</span> <span class="nx">pic</span> <span class="k">in</span> <span class="nx">stack</span>
        <span class="nv">left = </span><span class="k">if</span> <span class="nx">H</span><span class="p">.</span><span class="nx">float</span><span class="p">((</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">css</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">H</span><span class="p">.</span><span class="nx">float</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">css</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="k">then</span> <span class="s1">&#39;-=&#39;</span> <span class="k">else</span> <span class="s1">&#39;+=&#39;</span>
        <span class="nv">top = </span><span class="k">if</span> <span class="nx">H</span><span class="p">.</span><span class="nx">float</span><span class="p">((</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">css</span> <span class="s1">&#39;top&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">H</span><span class="p">.</span><span class="nx">float</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">css</span> <span class="s1">&#39;top&#39;</span><span class="p">)</span> <span class="k">then</span> <span class="s1">&#39;-=&#39;</span> <span class="k">else</span> <span class="s1">&#39;+=&#39;</span>
        <span class="p">(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">animate</span><span class="p">(</span><span class="nx">left</span><span class="o">:</span><span class="nx">left</span><span class="o">+</span><span class="nx">delta</span><span class="p">,</span> <span class="nx">top</span><span class="o">:</span><span class="nx">top</span><span class="o">+</span><span class="nx">delta</span><span class="p">,</span> <span class="mi">400</span><span class="p">).</span>
          <span class="nx">animate</span> <span class="nx">left</span><span class="o">:</span><span class="nx">flip</span><span class="p">[</span><span class="nx">left</span><span class="p">]</span><span class="o">+</span><span class="nx">delta</span><span class="p">,</span> <span class="nx">top</span><span class="o">:</span><span class="nx">flip</span><span class="p">[</span><span class="nx">top</span><span class="p">]</span><span class="o">+</span><span class="nx">delta</span><span class="p">,</span> <span class="mi">400</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Public-facing <strong>clear</strong> method. Clears the stack atop and places
<code>from</code> on top</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">clear: </span><span class="nf">(from)-&gt;</span>
      <span class="nx">@_clear</span> <span class="p">(</span><span class="nx">@get</span> <span class="s1">&#39;atop&#39;</span><span class="p">,</span> <span class="nx">from</span><span class="p">),</span> <span class="nx">from</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">delay</span> <span class="p">(</span><span class="o">=&gt;</span> <span class="p">(</span><span class="nx">$</span> <span class="nx">from</span><span class="p">).</span><span class="nx">css</span> <span class="s1">&#39;z-index&#39;</span><span class="p">,</span> <span class="nx">@topmost</span><span class="p">()),</span> <span class="mi">300</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h3>PHYSICS</h3>

<p>A mishmash of special-purpose hacks, not a whole self-consistent world.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">physics:</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p><strong>Dangle</strong> a pic back to 0 (or almost) rotation when you grab it.
Do it in several (500ms intervaled) random dangles, in alternating directions.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">dangle:</span>
      <span class="nv">start: </span><span class="nf">(pic)-&gt;</span>
        <span class="nx">@stop</span> <span class="nx">pic</span>
        <span class="nx">@_dangle</span> <span class="nx">pic</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">delay</span> <span class="p">(</span><span class="o">=&gt;</span> <span class="p">(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">data</span> <span class="s1">&#39;dangle&#39;</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span> <span class="o">=&gt;</span> <span class="nx">@_dangle</span> <span class="nx">pic</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="mi">500</span>
      <span class="nv">stop: </span><span class="nf">(pic) -&gt;</span>
        <span class="nx">clearInterval</span> <span class="p">(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">data</span> <span class="s1">&#39;dangle&#39;</span>
      <span class="nv">_dangle: </span><span class="nf">(pic)-&gt;</span>
        <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.ui-draggable-dragging&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nv">r = </span><span class="p">(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.5</span><span class="o">+</span><span class="nx">H</span><span class="p">.</span><span class="nx">rand</span><span class="p">())</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
          <span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span>
            <span class="nv">r = </span><span class="mi">0</span>
            <span class="nx">@stop</span> <span class="nx">pic</span>
          <span class="p">(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">,</span> <span class="nx">r</span><span class="p">).</span>
            <span class="nx">imgAnimate</span> <span class="nv">rotate: </span><span class="nx">r</span><span class="o">+</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">duration</span><span class="o">:</span><span class="mi">500</span><span class="p">,</span> <span class="nx">queue</span><span class="o">:</span><span class="kc">false</span><span class="p">}</span>
        <span class="k">else</span>
          <span class="nx">@stop</span> <span class="nx">pic</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Calculate the <strong>vector</strong> (distance with direction) from the position 500ms ago to the current one.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">vector: </span><span class="nf">(pic)-&gt;</span>
      <span class="p">[</span><span class="nx">before</span><span class="p">,</span> <span class="nx">now</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;position.before&#39;</span><span class="p">),</span> <span class="p">(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">position</span><span class="p">()]</span>
      <span class="nv">x: </span><span class="nx">now</span><span class="p">.</span><span class="nx">left</span><span class="o">-</span><span class="nx">before</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nv">y: </span><span class="nx">now</span><span class="p">.</span><span class="nx">top</span><span class="o">-</span><span class="nx">before</span><span class="p">.</span><span class="nx">top</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Calculate a slight (<code>damp</code>), <strong>frictional</strong> rotation of a pic according to it's <code>vector</code> when tossing and dragging it around. 
Within the global max rotation.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">friction: </span><span class="nf">(pic)-&gt;</span>
      <span class="p">[</span><span class="nx">vector</span><span class="p">,</span> <span class="nx">damp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="nx">@vector</span> <span class="nx">pic</span><span class="p">),</span> <span class="mi">500</span><span class="p">]</span>
      <span class="nv">r = </span><span class="p">(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="nx">vector</span><span class="p">.</span><span class="nx">x</span><span class="err">/damp)+(15*vector.y/damp)</span>
      <span class="nv">r = </span><span class="nx">H</span><span class="p">.</span><span class="nx">fit</span> <span class="o">-</span><span class="nx">PIC</span><span class="p">.</span><span class="nx">css</span><span class="p">.</span><span class="nx">rotation</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">css</span><span class="p">.</span><span class="nx">rotation</span>
      <span class="p">(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">data</span> <span class="s1">&#39;rotation&#39;</span><span class="p">,</span> <span class="nx">r</span>
      <span class="nv">rotate: </span><span class="nx">r</span><span class="o">+</span><span class="s1">&#39;deg&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p><strong>Setup</strong> calculates the end position after <strong>tossing</strong> a pic:
how slightly (<code>damp</code>) more it should keep going in the direction.
Setup sets the stage for <strong>step</strong>, which actually runs the animation and deals with wall bouncing.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">toss:</span>
      <span class="nx">setup</span><span class="o">:</span><span class="nf">(pic)-&gt;</span>
        <span class="p">[</span><span class="nx">vector</span><span class="p">,</span> <span class="nx">damp</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="nx">PIC</span><span class="p">.</span><span class="nx">physics</span><span class="p">.</span><span class="nx">vector</span> <span class="nx">pic</span><span class="p">),</span> <span class="mi">2</span><span class="p">]</span>
        <span class="p">(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="nx">leftToss</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">topToss</span><span class="o">:</span><span class="mi">0</span><span class="p">).</span><span class="nx">data</span>
          <span class="nv">left:</span>
            <span class="nv">original: </span><span class="nx">H</span><span class="p">.</span><span class="nx">float</span> <span class="p">(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">css</span> <span class="s1">&#39;left&#39;</span>
            <span class="nv">toss: </span><span class="nx">vector</span><span class="p">.</span><span class="nx">x</span><span class="err">/damp</span>
            <span class="nv">before: </span><span class="mi">0</span>
            <span class="nv">bounce: </span><span class="mi">1</span>
          <span class="nv">top:</span>
            <span class="nv">original: </span><span class="nx">H</span><span class="p">.</span><span class="nx">float</span> <span class="p">(</span><span class="nx">$</span> <span class="nx">pic</span><span class="p">).</span><span class="nx">css</span> <span class="s1">&#39;top&#39;</span>
            <span class="nv">toss: </span><span class="nx">vector</span><span class="p">.</span><span class="nx">y</span><span class="err">/damp</span>
            <span class="nv">before: </span><span class="mi">0</span>
            <span class="nv">bounce: </span><span class="mi">1</span>
        <span class="nx">leftToss</span><span class="o">:</span><span class="mi">100</span><span class="p">,</span> <span class="nx">topToss</span><span class="o">:</span><span class="mi">100</span>
      <span class="nv">step: </span><span class="nf">(now, fx)-&gt;</span>
        <span class="k">if</span> <span class="nx">fx</span><span class="p">.</span><span class="nx">prop</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;leftToss&#39;</span><span class="p">,</span> <span class="s1">&#39;topToss&#39;</span><span class="p">]</span>
          <span class="nv">lt = </span><span class="k">if</span> <span class="nx">fx</span><span class="p">.</span><span class="nx">prop</span> <span class="o">is</span> <span class="s1">&#39;leftToss&#39;</span> <span class="k">then</span> <span class="s1">&#39;left&#39;</span> <span class="k">else</span> <span class="s1">&#39;top&#39;</span>
          <span class="nv">pic = </span><span class="nx">$</span><span class="p">(</span><span class="nx">fx</span><span class="p">.</span><span class="nx">elem</span><span class="p">)</span>
          <span class="nv">param = </span><span class="nx">pic</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">lt</span><span class="p">)</span>
          <span class="nv">quanta = </span><span class="p">((</span><span class="nx">now</span> <span class="o">-</span> <span class="p">(</span><span class="nx">param</span><span class="p">.</span><span class="nx">before</span><span class="o">||</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="nx">param</span><span class="p">.</span><span class="nx">toss</span>
          <span class="nv">param.before = </span><span class="nx">now</span>
          <span class="nv">prop = </span><span class="nx">H</span><span class="p">.</span><span class="nx">float</span><span class="p">(</span><span class="nx">pic</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="nx">lt</span><span class="p">))</span> <span class="o">+</span> <span class="p">((</span><span class="nx">param</span><span class="p">.</span><span class="nx">bounce</span><span class="o">||</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nx">quanta</span><span class="p">)</span>
          <span class="nv">hw = </span><span class="k">if</span> <span class="nx">fx</span><span class="p">.</span><span class="nx">prop</span> <span class="o">is</span> <span class="s1">&#39;topToss&#39;</span> <span class="k">then</span> <span class="s1">&#39;height&#39;</span> <span class="k">else</span> <span class="s1">&#39;width&#39;</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">prop</span><span class="o">+</span><span class="nx">pic</span><span class="p">[</span><span class="nx">hw</span><span class="p">]()</span> <span class="o">&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#canvas&#39;</span><span class="p">)[</span><span class="nx">hw</span><span class="p">]()</span><span class="o">-</span><span class="mi">60</span><span class="p">)</span> <span class="o">or</span> <span class="nx">prop</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="nv">param.bounce = </span><span class="p">(</span><span class="nx">param</span><span class="p">.</span><span class="nx">bounce</span><span class="o">||</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.5</span>

          <span class="nx">pic</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span> <span class="nx">lt</span><span class="p">,</span> <span class="nx">H</span><span class="p">.</span><span class="nx">float</span><span class="p">(</span><span class="nx">pic</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="nx">lt</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="nx">param</span><span class="p">.</span><span class="nx">bounce</span><span class="o">||</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nx">quanta</span> <span class="p">)</span>
          <span class="nv">param = </span><span class="nx">pic</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">lt</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p><strong>Shuffle</strong> (rotate randomly) the pics that end up below <code>pic</code> halfway through its tossing.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">shuffle: </span><span class="nf">(pic)-&gt;</span>
      <span class="k">for</span> <span class="nx">below</span> <span class="k">in</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;below&#39;</span><span class="p">,</span> <span class="nx">pic</span><span class="p">)</span>
        <span class="nv">below = </span><span class="nx">$</span> <span class="nx">below</span>
        <span class="nx">below</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span> <span class="nx">rotation</span><span class="o">:</span><span class="nx">below</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">PIC</span><span class="p">.</span><span class="nx">css</span><span class="p">.</span><span class="nx">rotation</span><span class="o">*</span><span class="nx">H</span><span class="p">.</span><span class="nx">rand</span><span class="p">())</span> <span class="p">).</span>
          <span class="nx">imgAnimate</span> <span class="nx">rotate</span><span class="o">:</span><span class="nx">below</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">),</span> <span class="p">{</span><span class="nx">duration</span><span class="o">:</span><span class="mi">500</span><span class="p">,</span> <span class="nx">queue</span><span class="o">:</span><span class="kc">false</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Toggle <strong>flip</strong> a photo &amp; its commented backside. Normally a cool 3D effect, 
it downgrades to a simple class switch to deal with IE8-</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">flip:</span>
      <span class="nx">start</span><span class="o">:</span><span class="nf">()-&gt;</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">goodBrowser</span>
          <span class="nv">pic = </span><span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">)</span>
          <span class="nx">pic</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s1">&#39;flipped&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.backside&#39;</span><span class="p">)</span><span class="c1">#.jScrollPane()</span>
        <span class="k">else</span>
          <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">rotate3Di</span> <span class="s1">&#39;toggle&#39;</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="nv">sideChange: </span><span class="nx">PIC</span><span class="p">.</span><span class="nx">physics</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">middle</span>
      <span class="nx">middle</span><span class="o">:</span><span class="nf">()-&gt;</span>
        <span class="nv">pic = </span><span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s1">&#39;flipped&#39;</span><span class="p">).</span><span class="nx">hasClass</span> <span class="s1">&#39;flipped&#39;</span>
          <span class="nx">pic</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.backside&#39;</span><span class="p">).</span><span class="nx">animate</span><span class="p">(</span><span class="nx">scale</span><span class="o">:</span><span class="p">[</span><span class="nx">H</span><span class="p">.</span><span class="nx">xy</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">()</span> <span class="o">*</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">)],</span> <span class="mi">300</span><span class="p">)</span><span class="c1">#.jScrollPane()</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h3>EVENTS</h3>

<p>All the events associated with a pic.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">events:</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>On <strong>double click</strong>, clear pics atop and flip.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">dblclick: </span><span class="o">-&gt;</span>
      <span class="nx">PIC</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">clear</span> <span class="err">@</span>
      <span class="nx">PIC</span><span class="p">.</span><span class="nx">physics</span><span class="p">.</span><span class="nx">flip</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>On <strong>load</strong> of a pic's image, initialize with its heigh &amp; width, give it a slight rotation and scale tweak, 
and animate it as if falling. Also setup dragging &amp; pagination.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">load: </span><span class="o">-&gt;</span>
      <span class="nv">pic = </span><span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">parents</span> <span class="s1">&#39;.pic&#39;</span>
      <span class="nx">pic</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="nx">visibility</span><span class="o">:</span><span class="s1">&#39;visible&#39;</span><span class="p">).</span>
        <span class="nx">add</span><span class="p">(</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.backside&#39;</span><span class="p">)</span> <span class="p">).</span><span class="nx">css</span><span class="p">(</span> <span class="nv">height: </span><span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">outerHeight</span><span class="p">(),</span> <span class="nx">width</span><span class="o">:</span><span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">outerWidth</span><span class="p">()</span> <span class="p">).</span><span class="nx">end</span><span class="p">().</span>
        <span class="nx">data</span><span class="p">(</span> <span class="nx">rotation</span><span class="o">:</span><span class="nx">PIC</span><span class="p">.</span><span class="nx">css</span><span class="p">.</span><span class="nx">rotation</span><span class="o">*</span><span class="nx">H</span><span class="p">.</span><span class="nx">rand</span><span class="p">(),</span> <span class="nv">scale: </span><span class="p">(</span><span class="nx">PIC</span><span class="p">.</span><span class="nx">css</span><span class="p">.</span><span class="nx">scale</span><span class="o">+</span><span class="mf">0.25</span><span class="o">*</span><span class="nx">H</span><span class="p">.</span><span class="nx">rand</span><span class="p">())</span> <span class="p">).</span>
        <span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img, .backside&#39;</span><span class="p">).</span><span class="nx">transform</span><span class="p">(</span><span class="nx">rotate</span><span class="o">:</span><span class="nx">pic</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="nx">scale</span><span class="o">:</span><span class="nx">H</span><span class="p">.</span><span class="nx">xy</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">()</span> <span class="o">*</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.4</span><span class="p">)</span>
      <span class="nx">pic</span><span class="p">.</span><span class="nx">imgAnimate</span><span class="p">(</span><span class="nx">scale</span><span class="o">:</span><span class="p">[</span><span class="nx">H</span><span class="p">.</span><span class="nx">xy</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">()</span> <span class="o">*</span> <span class="nx">pic</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">)],</span> <span class="mi">600</span><span class="p">)</span>
      <span class="nx">pic</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">pile</span><span class="p">.</span><span class="nx">place</span> <span class="nx">pic</span><span class="p">,</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span> <span class="p">)</span>
      <span class="nx">PIC</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">drag</span><span class="p">.</span><span class="nx">setup</span><span class="p">()</span>
      <span class="nx">PIC</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">paginate</span><span class="p">.</span><span class="nx">setup</span> <span class="nx">DATA</span><span class="p">.</span><span class="nx">pics</span><span class="p">[</span><span class="nx">pic</span><span class="p">.</span><span class="nx">data</span> <span class="s1">&#39;order&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p><strong>Dragging</strong>. On <em>start</em>, clear pics atop and animate a slight size increase.
<em>While</em> dragging, have the pic dangle and give it some friction every 250ms, while keeping track of its position every 500ms.
When <em>stopping</em>, trigger tossing, size reduction back to normal, some friction, and some shuffling --unless the pic has been removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">drag:</span>
      <span class="nv">start: </span><span class="o">-&gt;</span>
        <span class="nx">PIC</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">clear</span> <span class="err">@</span>
        <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">imgAnimate</span><span class="p">(</span><span class="nx">scale</span><span class="o">:</span><span class="p">[</span><span class="nx">H</span><span class="p">.</span><span class="nx">xy</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">],</span> <span class="mi">300</span><span class="p">).</span>
          <span class="nx">data</span> <span class="s1">&#39;position.before&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">position</span><span class="p">()</span>
      <span class="k">while</span><span class="o">:</span> <span class="o">-&gt;</span>
        <span class="nx">PIC</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">drag</span><span class="p">.</span><span class="nx">whiles</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">call</span> <span class="err">@</span>
        <span class="nx">PIC</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">drag</span><span class="p">.</span><span class="nx">whiles</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">call</span> <span class="err">@</span>
      <span class="nv">whiles: </span><span class="p">[</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">throttle</span><span class="p">(</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.ui-draggable-dragging&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">imgAnimate</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">physics</span><span class="p">.</span><span class="nx">friction</span><span class="p">(</span><span class="err">@</span><span class="p">),</span> <span class="nx">duration</span><span class="o">:</span><span class="mi">200</span><span class="p">,</span> <span class="nx">queue</span><span class="o">:</span><span class="kc">false</span>
            <span class="nx">PIC</span><span class="p">.</span><span class="nx">physics</span><span class="p">.</span><span class="nx">dangle</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
        <span class="p">,</span> <span class="mi">250</span><span class="p">),</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">throttle</span><span class="p">(</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>To visualize a pic's vector: 
<code>H.line.draw(($ @).data('position.before'), ($ @).position())</code></p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">data</span> <span class="s1">&#39;position.before&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">position</span><span class="p">()</span>
        <span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
      <span class="p">]</span>
      <span class="nv">stop: </span><span class="o">-&gt;</span>
        <span class="nx">PIC</span><span class="p">.</span><span class="nx">physics</span><span class="p">.</span><span class="nx">dangle</span><span class="p">.</span><span class="nx">stop</span> <span class="err">@</span>
        <span class="nx">unless</span> <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">hasClass</span> <span class="s1">&#39;removed&#39;</span>
          <span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">animate</span><span class="p">(</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">physics</span><span class="p">.</span><span class="nx">toss</span><span class="p">.</span><span class="nx">setup</span><span class="p">(</span><span class="err">@</span><span class="p">),</span> <span class="nx">duration</span><span class="o">:</span><span class="mi">1000</span><span class="p">,</span> <span class="nx">step</span><span class="o">:</span><span class="nx">PIC</span><span class="p">.</span><span class="nx">physics</span><span class="p">.</span><span class="nx">toss</span><span class="p">.</span><span class="nx">step</span> <span class="p">).</span>
            <span class="nx">imgAnimate</span><span class="p">(</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="p">{</span><span class="nv">scale: </span><span class="p">[</span><span class="nx">H</span><span class="p">.</span><span class="nx">xy</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">scale</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">data</span> <span class="s1">&#39;scale&#39;</span><span class="p">]},</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">physics</span><span class="p">.</span><span class="nx">friction</span><span class="p">(</span><span class="err">@</span><span class="p">))</span> <span class="p">,</span> <span class="nx">duration</span><span class="o">:</span><span class="mi">1000</span><span class="p">,</span> <span class="nx">queue</span><span class="o">:</span><span class="kc">false</span><span class="p">)</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">delay</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">physics</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="err">@</span>
      <span class="nv">setup: </span><span class="o">-&gt;</span>
        <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#pics .pic&#39;</span><span class="p">).</span><span class="nx">draggable</span>
          <span class="nv">containment: </span><span class="s1">&#39;parent&#39;</span>
          <span class="nv">start: </span><span class="nx">@start</span>
          <span class="nv">drag: </span><span class="nx">@while</span>
          <span class="nv">stop: </span><span class="nx">@stop</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>At the <strong>trash</strong> bar, accept droppings and <em>delete</em> them, <em>restore</em> them on click.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">trash:</span>
      <span class="k">delete</span><span class="o">:</span> <span class="nf">(event, ui)-&gt;</span>
        <span class="p">(</span><span class="nx">$</span> <span class="nx">ui</span><span class="p">.</span><span class="nx">draggable</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;removed&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">()</span>
        <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#trash&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
      <span class="nv">restore: </span><span class="o">-&gt;</span>
        <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#pics .pic:hidden&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;removed&#39;</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">()</span>
        <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#trash&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
      <span class="nv">setup: </span><span class="o">-&gt;</span>
        <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#trash&#39;</span><span class="p">).</span><span class="nx">droppable</span><span class="p">(</span>
          <span class="nv">accept: </span><span class="s1">&#39;.pic&#39;</span>
          <span class="nv">hoverClass: </span><span class="s1">&#39;hover&#39;</span>
          <span class="nv">tolerance: </span><span class="s1">&#39;touch&#39;</span>
          <span class="nv">drop: </span><span class="nx">@delete</span>
        <span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">@restore</span><span class="p">).</span><span class="nx">hover</span><span class="p">(</span> <span class="p">(</span><span class="o">-&gt;</span><span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">addClass</span> <span class="s1">&#39;nondrag-hover&#39;</span><span class="p">),</span> <span class="p">(</span><span class="o">-&gt;</span><span class="p">(</span><span class="nx">$</span> <span class="err">@</span><span class="p">).</span><span class="nx">removeClass</span> <span class="s1">&#39;nondrag-hover&#39;</span><span class="p">)</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Bind all events to all pics.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">setup: </span><span class="nf">()-&gt;</span>
      <span class="nv">e = </span><span class="nx">PIC</span><span class="p">.</span><span class="nx">events</span>
      <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#pics .pic&#39;</span><span class="p">).</span><span class="nx">dblclick</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">dblclick</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">click</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">).</span><span class="nx">load</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">load</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h3>DISPLAY</h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">display:</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Insert, with the right z-index, the actual HTML for each of the <code>pics</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">setup</span><span class="o">:</span><span class="nf">(pics)-&gt;</span>
      <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#shoebox&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.loading&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
      <span class="nx">PIC</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">trash</span><span class="p">.</span><span class="nx">setup</span><span class="p">()</span>

      <span class="p">(</span><span class="nx">_</span> <span class="nx">pics</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(pic, i)-&gt;</span>
        <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#pics&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span> <span class="nx">DATA</span><span class="p">.</span><span class="nx">pics</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nv">$html = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;pic&quot; /&gt;&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="nx">order</span><span class="o">:</span><span class="nx">i</span><span class="p">).</span>
          <span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&lt;img src=&quot;&#39;</span><span class="o">+</span><span class="nx">pic</span><span class="p">.</span><span class="nx">url_s</span><span class="o">+</span><span class="s1">&#39;&quot; /&gt;&lt;div class=&quot;backside&quot;&gt;&lt;div class=&quot;text&quot;&gt;&lt;/div&gt;&lt;div class=&quot;pages&quot;&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&#39;</span><span class="p">)</span> <span class="p">).</span>
          <span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.pic:last&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;z-index&#39;</span><span class="p">,</span> <span class="nx">PIC</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">topmost</span><span class="p">())</span>
      <span class="nx">PIC</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">setup</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p><strong>Pagination</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">paginate:</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Setup a pic's commented backside.
If IE8- page naively (1 comment per page).</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">setup: </span><span class="nf">(pic)-&gt;</span>
        <span class="nv">comments = </span><span class="nx">_</span><span class="p">(</span><span class="nx">pic</span><span class="p">.</span><span class="nx">comments</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">PIC</span><span class="p">.</span><span class="nx">display</span><span class="p">.</span><span class="nx">comment</span><span class="p">)</span>
        <span class="vi">@text = </span><span class="nx">pic</span><span class="p">.</span><span class="nx">$html</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.text&#39;</span><span class="p">)</span>
        <span class="vi">@backside = </span><span class="nx">pic</span><span class="p">.</span><span class="nx">$html</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.backside&#39;</span><span class="p">)</span>
        <span class="vi">@pages = </span><span class="nx">pic</span><span class="p">.</span><span class="nx">$html</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.pages&#39;</span><span class="p">)</span>
        <span class="nv">pic.comments.grouped = grouped = </span><span class="k">if</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">goodBrowser</span> <span class="k">then</span> <span class="nx">@group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">comments</span><span class="p">)</span> <span class="k">else</span> <span class="nx">_</span><span class="p">(</span><span class="nx">comments</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nf">(c)-&gt;</span><span class="p">[</span><span class="nx">c</span><span class="p">])</span>
        <span class="nx">@text</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;grouped&#39;</span><span class="p">,</span> <span class="nx">grouped</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">grouped</span><span class="p">[</span><span class="mi">0</span><span class="p">]...</span>
        <span class="nx">@number</span><span class="p">(</span><span class="nx">grouped</span><span class="p">)</span> <span class="k">if</span> <span class="nx">grouped</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="nx">@backside</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;badBrowser&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">goodBrowser</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Number pages.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">number: </span><span class="nf">(grouped)-&gt;</span>
          <span class="nx">@pages</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;javascript:void(0)&quot;&gt;&#39;</span><span class="o">+</span><span class="nx">page</span><span class="o">+</span><span class="s1">&#39;&lt;/a&gt;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">page</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">grouped</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
          <span class="nx">@pages</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="nx">@page</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">)</span>
          <span class="nx">@text</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;paged&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Page switching.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">page: </span><span class="o">-&gt;</span>
        <span class="nv">text = </span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">parents</span><span class="p">(</span><span class="s1">&#39;.backside&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.text&#39;</span><span class="p">)</span>
        <span class="nx">text</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">text</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;grouped&#39;</span><span class="p">)[</span><span class="nx">H</span><span class="p">.</span><span class="nx">float</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">text</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]...</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">siblings</span><span class="p">().</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">).</span><span class="nx">end</span><span class="p">().</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p><strong>Group</strong> smartly as many comments per page as can fit.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">group: </span><span class="nf">(perpage, comments, grouped=[])-&gt;</span>
        <span class="p">[</span><span class="nx">first</span><span class="p">,</span> <span class="nx">rest</span><span class="p">]</span> <span class="o">=</span> <span class="nx">H</span><span class="p">.</span><span class="nx">split</span> <span class="nx">comments</span><span class="p">,</span> <span class="nx">perpage</span>
        <span class="nx">@text</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">first</span><span class="p">...</span>
        <span class="k">if</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nv">grouped =</span>
            <span class="k">if</span> <span class="nx">perpage</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">@text</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nx">@backside</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span>
              <span class="nx">@group</span> <span class="nx">perpage</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">comments</span><span class="p">,</span> <span class="nx">grouped</span>
            <span class="k">else</span>
              <span class="p">[</span><span class="nx">first</span><span class="p">,</span> <span class="nx">rest</span><span class="p">]</span> <span class="o">=</span> <span class="nx">H</span><span class="p">.</span><span class="nx">split</span> <span class="nx">comments</span><span class="p">,</span> <span class="nx">perpage</span><span class="o">-</span><span class="mi">1</span>
              <span class="nx">grouped</span><span class="p">[</span><span class="nx">grouped</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">first</span>
              <span class="nx">@group</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">rest</span><span class="p">,</span> <span class="nx">grouped</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="nx">perpage</span> <span class="o">isnt</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">@text</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="nx">@backside</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span>
            <span class="p">[</span><span class="nx">grouped</span><span class="p">[</span><span class="nx">grouped</span><span class="p">.</span><span class="nx">length</span><span class="p">],</span> <span class="nx">grouped</span><span class="p">[</span><span class="nx">grouped</span><span class="p">.</span><span class="nx">length</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">H</span><span class="p">.</span><span class="nx">split</span> <span class="nx">comments</span><span class="p">,</span> <span class="nx">perpage</span><span class="o">-</span><span class="mi">1</span>
          <span class="k">else</span>
            <span class="nx">grouped</span><span class="p">[</span><span class="nx">grouped</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="o">=</span> <span class="nx">comments</span>
        <span class="nx">grouped</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>The actual HTML enclosure for each comment.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">comment: </span><span class="nf">(c)-&gt;</span>
      <span class="s2">&quot;&lt;div class=\&quot;comment\&quot;&gt;#{c.comment}&lt;/div&gt;&lt;div class=\&quot;author\&quot;&gt;- #{c.author}&lt;/div&gt;&quot;</span>
<span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <h3>HELPERS</h3>

<p>A mishmash of helper methods, the bulk of them geometry related.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nv">H = H =</span>
  <span class="nv">xy: </span><span class="nf">(n)-&gt;</span><span class="p">[</span><span class="nx">n</span><span class="p">,</span><span class="nx">n</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Sugar to ensure <code>between</code> falls between <code>min</code> and <code>max</code>. Most conceptually helpful function ever.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fit: </span><span class="nf">(min, between, max)-&gt;</span>
    <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">max</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="nx">min</span><span class="p">,</span> <span class="nx">between</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Sugar to split an array into 2 parts around <code>split</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">split: </span><span class="nf">(array, split)-&gt;</span> <span class="p">[</span><span class="nx">_</span><span class="p">(</span><span class="nx">array</span><span class="p">).</span><span class="nx">first</span><span class="p">(</span><span class="nx">split</span><span class="p">),</span> <span class="nx">_</span><span class="p">(</span><span class="nx">array</span><span class="p">).</span><span class="nx">rest</span><span class="p">(</span><span class="nx">split</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p><strong>Points</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">point:</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p><strong>Multiply</strong> any number of points. Each coordinate times it's respective coordinate.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">multiply: </span><span class="nf">(a, b...)-&gt;</span>
      <span class="p">[</span><span class="nx">b</span><span class="p">,</span> <span class="nx">rest</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">_</span><span class="p">(</span><span class="nx">b</span><span class="p">).</span><span class="nx">rest</span><span class="p">()]</span>
      <span class="nv">out = x: </span><span class="nx">a</span><span class="p">.</span><span class="nx">x</span><span class="o">*</span><span class="nx">b</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nv">y: </span><span class="nx">a</span><span class="p">.</span><span class="nx">y</span><span class="o">*</span><span class="nx">b</span><span class="p">.</span><span class="nx">y</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">(</span><span class="nx">rest</span><span class="p">).</span><span class="nx">isEmpty</span><span class="p">()</span> <span class="k">then</span> <span class="nx">H</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nx">rest</span><span class="p">...)</span>  <span class="k">else</span> <span class="nx">out</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p><strong>Lines</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">line:</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Calculate a line's <strong>length</strong>. We love you Pythagoras.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">length: </span><span class="nf">(l)-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span><span class="o">-</span><span class="nx">l</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">y</span><span class="o">-</span><span class="nx">l</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Assume the line is parallel to one of the axis and <strong>flatten</strong> it (get only the changing values).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">flatten: </span><span class="nf">(l)-&gt;</span> <span class="k">if</span> <span class="nx">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span> <span class="o">is</span> <span class="nx">l</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">x</span> <span class="k">then</span> <span class="p">[</span><span class="nx">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">y</span><span class="p">,</span> <span class="nx">l</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">y</span><span class="p">]</span> <span class="k">else</span> <span class="p">[</span><span class="nx">l</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="nx">l</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">x</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Find out if two lines <strong>intersect</strong> by assuming they are paralell to the axes
and flattening them. If the length of their flattening is smaller than the sum of each line,
then they intersect.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">intersect: </span><span class="nf">(a, b)-&gt;</span>
      <span class="nv">points = </span><span class="nx">_</span><span class="p">.</span><span class="nx">union</span> <span class="nx">@flatten</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nx">@flatten</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
      <span class="p">(</span><span class="nx">_</span> <span class="nx">points</span><span class="p">).</span><span class="nx">max</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">points</span><span class="p">).</span><span class="nx">min</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nx">@length</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">+</span> <span class="nx">@length</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p><strong>Draw</strong> a red line with canvas. For debugging purposes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">draw: </span><span class="nf">(a, b)-&gt;</span>
      <span class="nv">c = </span><span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;#overlay&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">getContext</span> <span class="s1">&#39;2d&#39;</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span><span class="o">||</span><span class="nx">a</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span><span class="o">||</span><span class="nx">a</span><span class="p">.</span><span class="nx">top</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">lineTo</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span><span class="o">||</span><span class="nx">b</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span><span class="o">||</span><span class="nx">b</span><span class="p">.</span><span class="nx">top</span>
      <span class="nv">c.lineWidth = </span><span class="mi">5</span>
      <span class="nv">c.strokeStyle = </span><span class="s1">&#39;red&#39;</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">stroke</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p><strong>Rectangles</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rect:</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p><strong>Extract</strong> an unrotated (for simplicity) rectangle from a given object <code>o</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">extract: </span><span class="nf">(o)-&gt;</span>
      <span class="nv">o = </span><span class="nx">$</span> <span class="nx">o</span>
      <span class="nv">parent = </span><span class="nx">o</span><span class="p">.</span><span class="nx">parents</span><span class="p">(</span><span class="s1">&#39;#pics, #canvas&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>We go to such lengths here to get the offset because the image parent (.pic) 
has it's left and top erased by <a href="[https://github.com/heygrady/transform]">the rotate plugin</a> in IE8-.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">[</span><span class="nx">left</span><span class="p">,</span> <span class="nx">top</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">outerWidth</span><span class="p">(),</span> <span class="nx">o</span><span class="p">.</span><span class="nx">outerHeight</span><span class="p">()]</span>
      <span class="nv">tl: </span><span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">left</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="nx">top</span><span class="p">},</span> <span class="nv">tr: </span><span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">left</span><span class="o">+</span><span class="nx">width</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="nx">top</span><span class="p">}</span>
      <span class="nv">bl: </span><span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">left</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="nx">top</span><span class="o">+</span><span class="nx">height</span><span class="p">},</span> <span class="nv">br: </span><span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">left</span><span class="o">+</span><span class="nx">width</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="nx">top</span><span class="o">+</span><span class="nx">height</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p><strong>Draw</strong> a rectangle <code>r</code> of a given <code>color</code>. For debugging purposes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">draw: </span><span class="nf">(r, color=&#39;red&#39;)-&gt;</span>
      <span class="p">(</span><span class="nx">$</span> <span class="s1">&#39;&lt;div class=&quot;rect&quot;/&gt;&#39;</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;#canvas&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="nx">top</span><span class="o">:</span><span class="nx">r</span><span class="p">.</span><span class="nx">tl</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">left</span><span class="o">:</span><span class="nx">r</span><span class="p">.</span><span class="nx">tl</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">width</span><span class="o">:</span><span class="nx">r</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nx">x</span><span class="o">-</span><span class="nx">r</span><span class="p">.</span><span class="nx">tl</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">height</span><span class="o">:</span><span class="nx">r</span><span class="p">.</span><span class="nx">bl</span><span class="p">.</span><span class="nx">y</span><span class="o">-</span><span class="nx">r</span><span class="p">.</span><span class="nx">tl</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">background</span><span class="o">:</span><span class="nx">color</span><span class="p">)</span>
    <span class="nv">intersect: </span><span class="nf">(a, b)-&gt;</span>
      <span class="p">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="nx">@extract</span> <span class="nx">a</span><span class="p">),</span> <span class="p">(</span><span class="nx">@extract</span> <span class="nx">b</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>To visualize this beautifully, activate here:
<code>H.rect.draw a</code>
<code>H.rect.draw b, 'blue'</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">out = </span><span class="nx">H</span><span class="p">.</span><span class="nx">line</span><span class="p">.</span><span class="nx">intersect</span><span class="p">([</span><span class="nx">a</span><span class="p">.</span><span class="nx">tl</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">tr</span><span class="p">],</span> <span class="p">[</span><span class="nx">b</span><span class="p">.</span><span class="nx">tl</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tr</span><span class="p">])</span> <span class="o">and</span>
        <span class="nx">H</span><span class="p">.</span><span class="nx">line</span><span class="p">.</span><span class="nx">intersect</span><span class="p">([</span><span class="nx">a</span><span class="p">.</span><span class="nx">tl</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">bl</span><span class="p">],</span> <span class="p">[</span><span class="nx">b</span><span class="p">.</span><span class="nx">tl</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">bl</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Convenience positive/negative &lt;.5 randomness.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rand: </span><span class="o">-&gt;</span> <span class="p">.</span><span class="mi">5</span><span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Sort an array randomly.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">shuffle: </span><span class="nf">(array) -&gt;</span> <span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">sort</span> <span class="o">-&gt;</span> <span class="nx">H</span><span class="p">.</span><span class="nx">rand</span><span class="p">()</span> <span class="p">)</span>
  <span class="nv">float: </span><span class="nf">(str)-&gt;</span> <span class="nb">parseFloat</span> <span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>A <strong>log</strong> that prints an object (see below) AND returns it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">log: </span><span class="nf">(text, o=&#39;&#39;) -&gt;</span>
    <span class="k">if</span> <span class="nx">o</span><span class="o">?</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">text</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="nx">H</span><span class="p">.</span><span class="nx">print</span> <span class="nx">o</span>
      <span class="nx">o</span>
    <span class="k">else</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">H</span><span class="p">.</span><span class="nx">print</span> <span class="nx">text</span>
      <span class="nx">text</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>A convenience method to actually <strong>print</strong> (output as text) the contents of an object.
Chrome's console instead displays an interactive object which is akward to use and sometimes 
downright unhelpful (because objects change).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">print: </span><span class="nf">(obj)-&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isPlainObject</span> <span class="nx">obj</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">obj</span><span class="p">).</span><span class="nx">isString</span><span class="p">()</span> <span class="o">or</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">obj</span><span class="p">).</span><span class="nx">isNumber</span><span class="p">()</span> <span class="o">or</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">obj</span><span class="p">).</span><span class="nx">isBoolean</span><span class="p">()</span> <span class="o">or</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">obj</span><span class="p">).</span><span class="nx">isDate</span><span class="p">()</span> <span class="o">or</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">obj</span><span class="p">).</span><span class="nx">isRegExp</span><span class="p">()</span>
        <span class="nx">obj</span><span class="o">+</span><span class="s1">&#39;&#39;</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">obj</span><span class="p">).</span><span class="nx">isArray</span><span class="p">()</span>
          <span class="s1">&#39;[ &#39;</span><span class="o">+</span> <span class="p">(</span><span class="nx">H</span><span class="p">.</span><span class="nx">print</span> <span class="nx">el</span> <span class="k">for</span> <span class="nx">el</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; ]&#39;</span>
        <span class="k">else</span>
          <span class="nx">obj</span>
    <span class="k">else</span>
      <span class="s1">&#39;{ &#39;</span><span class="o">+</span><span class="p">(</span><span class="s2">&quot;#{key}:#{if $.isPlainObject value then H.print value else value}&quot;</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">obj</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; }&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p><em>Launch the snowball!</em></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$</span> <span class="o">-&gt;</span> <span class="nx">BOX</span><span class="p">.</span><span class="nx">setup</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p><strong>Animate</strong> the <code>img</code> and <code>.backside</code> children of the current pic.
Originally, the container div <code>.pic</code> was the one rotated, but to accommodate IE8 we need to keep it "clean"
and animate the children instead.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">$.fn.imgAnimate = </span><span class="nf">(args...) -&gt;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img, .backside&#39;</span><span class="p">).</span><span class="nx">animate</span> <span class="nx">args</span><span class="p">...</span>
  <span class="k">return</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Convenience method to <strong>multiply</strong> a CSS property by a multiple. 
It always uses the original (premultiply) value of the CSS property.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">$.fn.cssMultiply = </span><span class="nf">(attrs, multiple) -&gt;</span>
  <span class="p">(</span><span class="nx">_</span> <span class="nx">attrs</span><span class="p">).</span><span class="nx">each</span> <span class="p">(</span><span class="nx">attr</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="s1">&#39;premultiply-&#39;</span><span class="o">+</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">H</span><span class="p">.</span><span class="nx">float</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;premultiply-&#39;</span><span class="o">+</span><span class="nx">attr</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="nx">attr</span><span class="p">))</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span> <span class="nx">attr</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;premultiply-&#39;</span><span class="o">+</span><span class="nx">attr</span><span class="p">)</span><span class="o">*</span> <span class="nx">multiple</span> <span class="p">)</span>
  <span class="k">return</span> <span class="k">this</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 